# 영속성 컨텍스트 (Persistence Context)

> 작성한 내용은 김영한님의 강의 <자바 ORM 표준 JPA 프로그래밍 - 기본편> 의 내용에서 일부 발췌하였습니다.   
> 문제가 될 경우 해당 게시글은 삭제됩니다.

## 영속성 컨텍스트란?

 - **엔티티를 영구 저장하는 환경** 이라는 의미
 - EntityManager.persist(entity);
    - entity를 DB에 저장한다 (표면적 의미) --> 사실 이 단계에서 DB에 변동사항이 저장되지 않는다.
    - 영속성 컨텍스트를 통해 entity를 영속화한다. == 영속성 컨텍스트에 entity를 등록

## 엔티티 매니저를 통해 영속성 컨텍스트에 접근

## 엔티티의 생명주기
  - 비영속(new / transient) : 영속성 컨텍스트와 전혀 관계가 없는 새로운 상태 -> 단순히 객체만 생성한 상태
  - 영속(managed) : 영속성 컨텍스트에 관리되는 상태 -> 생성된 객체를 영속성 컨텍스트(entity manager)에 persist
  - 준영속(detached) : 영속성 컨텍스트에 저장되었다가 분리된 상태 -> DB와 관련없이 영속성 컨텍스트에서 분리
  - 삭제(removed) : 삭제된 상태 -> DB에서 (객체가) 삭제된 상태

## 영속성 컨텍스트의 이점

  - 1차 캐시 : 영속성 컨텍스트 내부에서 key(@Id, PK) | value(해당 객체) 형태로 저장 --> 조회의 이점
      - 조회 결과가 없을 경우 DB에서 조회후 조회된 결과를 1차 캐시에 저장 -> 이후 1차 캐시에서 우선 조회
      - 단일 트랜잭션 내에서만 유효한 개념. 트랜잭션이 종료된 후엔 1차 캐시도 사라진다.
  - 동일성 보장 : 같은 트랜잭션안에서 같은 PK로 불러온 객체의 동일성을 보장한다. 자바의 컬렉션(주소를 통해 값 참조)과 유사하다.
  - 트랜잭션을 지원하는 쓰기 지연 : 커밋하는 순간에 DB에 SQL을 보낸다. (이전까진 *쓰기 지연 SQL  저장소*에 쌓아만 둔다.)
  - 변경 감지(Dirty Checking) : 조회한 객체를 setter를 통해 값 변경 시 JPA가 자동으로 수정한다. (update 쿼리가 필요하지 않다.)